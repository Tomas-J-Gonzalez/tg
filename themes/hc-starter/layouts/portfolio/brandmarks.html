{{ define "main" }}
<main id="main-content" class="region flow">
  <article class="flow">
    <header class="flow">
      <h1>{{ .Title }}</h1>
      {{ with .Params.subtitle }}<p class="subtitle">{{ . }}</p>{{ end }}
    </header>

    {{ if .Params.description }}
    <div class="project-overview">
      <p>{{ .Params.description }}</p>
    </div>
    {{ end }}

    <div class="accordion-container">
      {{ range .Params.blocks }}
        {{ if eq .template "body-copy" }}
          {{ if and .heading (not (eq .heading "Project Overview")) (not (eq .heading "Design Collection")) (not (eq .heading "Design Process")) (not (eq .heading "Results")) (not (eq .heading "Technologies Used")) }}
            {{ $currentHeading := .heading }}
            <div class="accordion-card" data-brand="{{ .heading | urlize }}">
              <div class="accordion-header">
                <h3 class="accordion-title">{{ .heading }}</h3>
                <div class="accordion-controls">
                  <button class="accordion-toggle" aria-expanded="false" aria-controls="content-{{ .heading | urlize }}">
                    <i class="fas fa-chevron-down" aria-hidden="true"></i>
                  </button>
                  <button class="accordion-share" aria-label="Share {{ .heading }}">
                    <i class="fas fa-share-alt" aria-hidden="true"></i>
                  </button>
                </div>
              </div>
              <div class="accordion-content" id="content-{{ .heading | urlize }}">
                <div class="accordion-body">
                  {{ if .content }}
                    <div class="brand-description">
                      {{ .content | markdownify }}
                    </div>
                  {{ end }}
                  <div class="brand-images">
                    {{ range $.Params.blocks }}
                      {{ if eq .template "image" }}
                        {{ if eq .brand $currentHeading }}
                          <figure class="brand-image">
                            <img src="{{ .src }}" alt="{{ .alt }}" loading="lazy">
                            {{ if .caption }}
                              <figcaption>{{ .caption }}</figcaption>
                            {{ end }}
                          </figure>
                        {{ end }}
                      {{ end }}
                    {{ end }}
                  </div>
                </div>
              </div>
            </div>
          {{ end }}
        {{ end }}
      {{ end }}
    </div>

    {{ range .Params.blocks }}
      {{ if eq .template "body-copy" }}
        {{ if or (eq .heading "Design Process") (eq .heading "Results") (eq .heading "Technologies Used") }}
          <section class="project-section">
            <h2>{{ .heading }}</h2>
            {{ .content | markdownify }}
          </section>
        {{ end }}
      {{ end }}
    {{ end }}
  </article>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const accordionToggles = document.querySelectorAll('.accordion-toggle');
  
  accordionToggles.forEach(toggle => {
    toggle.addEventListener('click', function() {
      const card = this.closest('.accordion-card');
      const content = card.querySelector('.accordion-content');
      const icon = this.querySelector('i');
      const isExpanded = this.getAttribute('aria-expanded') === 'true';
      
      // Close all other accordions
      accordionToggles.forEach(otherToggle => {
        if (otherToggle !== this) {
          const otherCard = otherToggle.closest('.accordion-card');
          const otherContent = otherCard.querySelector('.accordion-content');
          const otherIcon = otherToggle.querySelector('i');
          
          otherToggle.setAttribute('aria-expanded', 'false');
          otherContent.style.maxHeight = '0';
          otherIcon.classList.remove('fa-chevron-up');
          otherIcon.classList.add('fa-chevron-down');
        }
      });
      
      // Toggle current accordion
      if (isExpanded) {
        this.setAttribute('aria-expanded', 'false');
        content.style.maxHeight = '0';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      } else {
        this.setAttribute('aria-expanded', 'true');
        content.style.maxHeight = content.scrollHeight + 'px';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      }
    });
  });
  
  // Share functionality
  const shareButtons = document.querySelectorAll('.accordion-share');
  shareButtons.forEach(button => {
    button.addEventListener('click', function() {
      const card = this.closest('.accordion-card');
      const title = card.querySelector('.accordion-title').textContent;
      const url = window.location.href + '#' + card.dataset.brand;
      
      if (navigator.share) {
        navigator.share({
          title: title,
          url: url
        });
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
          // Show a brief notification
          const notification = document.createElement('div');
          notification.className = 'share-notification';
          notification.textContent = 'Link copied to clipboard';
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.remove();
          }, 2000);
        });
      }
    });
  });
});
</script>
{{ end }}
